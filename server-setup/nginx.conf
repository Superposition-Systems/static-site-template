# =============================================================================
# Static Sites — nginx config
# =============================================================================
# Maps incoming hostname to a directory under /sites/.
#
# Request to lotus-landscaping.qa.superposition.systems
#   → serves /sites/lotus-landscaping/
#
# Falls back to a simple 404 page if the site directory doesn't exist.
# =============================================================================

# Extract subdomain from any Host header (works regardless of base domain)
# Captures everything before the first dot-separated domain segment pair
# e.g., "lotus-landscaping" from "lotus-landscaping.qa.superposition.systems"
map $host $site_name {
    ~^(?P<sub>[^.]+)\. $sub;
    default "";
}

server {
    listen 80;
    server_name _;

    # Health check endpoint for Docker/Traefik
    location /health {
        access_log off;
        return 200 "ok\n";
        add_header Content-Type text/plain;
    }

    # Serve site files
    location / {
        # Reject requests with no valid subdomain
        if ($site_name = "") {
            return 404;
        }

        root /sites/$site_name;
        index index.html;
        try_files $uri $uri/ /index.html;

        # Cache static assets
        location ~* \.(css|js|jpg|jpeg|png|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 7d;
            add_header Cache-Control "public, immutable";
        }
    }

    # Custom 404
    error_page 404 /404.html;
    location = /404.html {
        internal;
        return 404 '<!DOCTYPE html><html><head><title>Not Found</title><style>body{font-family:system-ui;display:flex;justify-content:center;align-items:center;min-height:100vh;margin:0;background:#f5f5f5;color:#333}div{text-align:center}h1{font-size:4rem;margin:0;color:#999}p{color:#666}</style></head><body><div><h1>404</h1><p>Site not found</p></div></body></html>';
        add_header Content-Type text/html;
    }
}
