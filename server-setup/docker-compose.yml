# =============================================================================
# Static Sites — Shared nginx container
# =============================================================================
# Serves all static sites from /opt/sites/{subdomain}/ directories.
# Lives at /opt/apps/static-sites/ on the QA server.
#
# Routing is handled by Traefik's file provider — each site gets a dynamic
# route config in /opt/traefik/dynamic/{site-name}.yml that points to this
# container's service (static-sites@docker).
#
# Usage:
#   docker compose up -d
#
# To deploy a new site:
#   1. rsync files to /opt/sites/{site-name}/
#   2. Write route config to /opt/traefik/dynamic/{site-name}.yml
#   (The deploy-qa.yml GitHub Action does both automatically)
# =============================================================================

services:
  static-sites:
    image: nginx:alpine
    container_name: static-sites
    restart: unless-stopped
    volumes:
      - /opt/sites:/sites:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - web
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=web"
      # Service definition only — routers are added per-site via file provider
      - "traefik.http.services.static-sites.loadbalancer.server.port=80"
      # Security headers middleware for static sites
      - "traefik.http.middlewares.static-sites-security.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.static-sites-security.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.static-sites-security.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.static-sites-security.headers.browserXssFilter=true"
      - "traefik.http.middlewares.static-sites-security.headers.referrerPolicy=strict-origin-when-cross-origin"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost/health || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

networks:
  web:
    external: true
